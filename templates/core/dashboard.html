{% extends 'core/base.html' %}

{% block title %}Solar Power Prediction Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-white mb-3">
                <i class="fas fa-solar-panel me-3"></i>
                Solar Power Prediction System
            </h1>
            <p class="lead text-white-50">AI-powered solar energy output predictions with optimal configuration recommendations</p>
        </div>
    </div>
</div>

<!-- Main Action Cards -->
<div class="row mb-5">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="stats-icon text-primary">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3 class="card-title">Power Prediction</h3>
                <p class="card-text text-muted mb-4">Get AI-powered predictions for solar power output based on location and panel configuration.</p>
                <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#predictionModal">
                    <i class="fas fa-calculator me-2"></i>
                    Make Prediction
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="stats-icon text-success">
                    <i class="fas fa-bullseye"></i>
                </div>
                <h3 class="card-title">Optimal Configuration</h3>
                <p class="card-text text-muted mb-4">Find the optimal tilt and azimuth angles to maximize your solar power generation.</p>
                <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#recommendationModal">
                    <i class="fas fa-crosshairs me-2"></i>
                    Get Recommendation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Predictions
                </h5>
            </div>
            <div class="card-body">
                {% if recent_predictions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Output</th>
                                    <th>Timeframe</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prediction in recent_predictions %}
                                <tr>
                                    <td>{{ prediction.location.name|truncatechars:20 }}</td>
                                    <td>{{ prediction.predicted_output|floatformat:2 }} kWh</td>
                                    <td>
                                        <span class="badge bg-info">{{ prediction.timeframe|title }}</span>
                                    </td>
                                    <td>
                                        <a href="{% url 'prediction_detail' prediction.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No predictions yet. Make your first prediction!</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Recent Recommendations
                </h5>
            </div>
            <div class="card-body">
                {% if recent_recommendations %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Optimal Tilt</th>
                                    <th>Improvement</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for recommendation in recent_recommendations %}
                                <tr>
                                    <td>{{ recommendation.location.name|truncatechars:20 }}</td>
                                    <td>{{ recommendation.optimal_tilt }}°</td>
                                    <td>
                                        {% if recommendation.improvement_percentage %}
                                            <span class="badge bg-success">+{{ recommendation.improvement_percentage|floatformat:1 }}%</span>
                                        {% else %}
                                            <span class="badge bg-success">+0.0%</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'recommendation_detail' recommendation.id %}" class="btn btn-sm btn-outline-success">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No recommendations yet. Get your first recommendation!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Prediction Modal -->
<div class="modal fade" id="predictionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>
                    Solar Power Prediction
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="predictionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Location Information</h6>
                            <div class="mb-3">
                                <label for="location_name" class="form-label">Location Name (optional)</label>
                                <input type="text" class="form-control" id="location_name" placeholder="e.g., San Francisco, CA">
                            </div>
                            <div class="mb-3">
                                <label for="latitude" class="form-label">Latitude *</label>
                                <input type="number" class="form-control" id="latitude" step="0.000001" min="-90" max="90" required>
                            </div>
                            <div class="mb-3">
                                <label for="longitude" class="form-label">Longitude *</label>
                                <input type="number" class="form-control" id="longitude" step="0.000001" min="-180" max="180" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Panel Configuration</h6>
                            <div class="mb-3">
                                <label for="surface_area" class="form-label">Surface Area (m²) *</label>
                                <input type="number" class="form-control" id="surface_area" step="0.1" min="0.1" required>
                            </div>
                            <div class="mb-3">
                                <label for="tilt_angle" class="form-label">Tilt Angle (degrees) *</label>
                                <input type="number" class="form-control" id="tilt_angle" step="1" min="0" max="90" required>
                            </div>
                            <div class="mb-3">
                                <label for="azimuth_angle" class="form-label">Azimuth Angle (degrees) *</label>
                                <input type="number" class="form-control" id="azimuth_angle" step="1" min="0" max="360" required>
                            </div>
                            <div class="mb-3">
                                <label for="panel_efficiency" class="form-label">Panel Efficiency (0-1)</label>
                                <input type="number" class="form-control" id="panel_efficiency" step="0.01" min="0.01" max="1" value="0.20">
                            </div>
                            <div class="mb-3">
                                <label for="timeframe" class="form-label">Prediction Timeframe *</label>
                                <select class="form-control" id="timeframe" required>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitPrediction">
                    <i class="fas fa-calculator me-2"></i>
                    Generate Prediction
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    // Debounce function (slow down API calls)
    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }
    
    // Location name se coordinates fetch
    async function getCoordinates(location) {
        if (!location) return null;
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.length > 0) {
            return { lat: data[0].lat, lon: data[0].lon };
        }
        return null;
    }
    
    // Coordinates se location name fetch
    async function getLocationName(lat, lon) {
        if (!lat || !lon) return "";
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
        const res = await fetch(url);
        const data = await res.json();
        return data.display_name || "";
    }
    
    // Input fields
    const locationInput = document.getElementById("location_name");
    const latInput = document.getElementById("latitude");
    const lonInput = document.getElementById("longitude");
    
    // --- Location name change hone par ---
    locationInput.addEventListener("input", debounce(async () => {
        const location = locationInput.value.trim();
        if (location.length > 2) {
            const coords = await getCoordinates(location);
            if (coords) {
                latInput.value = coords.lat;
                lonInput.value = coords.lon;
            }
        }
    }, 600));
    
    // --- Latitude / Longitude change hone par ---
    async function updateLocationFromLatLon() {
        const lat = latInput.value.trim();
        const lon = lonInput.value.trim();
        if (lat && lon) {
            const locName = await getLocationName(lat, lon);
            if (locName) {
                locationInput.value = locName;
            }
        }
    }
    
    latInput.addEventListener("input", debounce(updateLocationFromLatLon, 700));
    lonInput.addEventListener("input", debounce(updateLocationFromLatLon, 700));
</script>

<!-- Recommendation Modal -->
<div class="modal fade" id="recommendationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bullseye me-2"></i>
                    Optimal Configuration Recommendation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="recommendationForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Location Information</h6>
                            <div class="mb-3">
                                <label for="rec_location_name" class="form-label">Location Name (optional)</label>
                                <input type="text" class="form-control" id="rec_location_name" placeholder="e.g., San Francisco, CA">
                            </div>
                            <div class="mb-3">
                                <label for="rec_latitude" class="form-label">Latitude *</label>
                                <input type="number" class="form-control" id="rec_latitude" step="0.000001" min="-90" max="90" required>
                            </div>
                            <div class="mb-3">
                                <label for="rec_longitude" class="form-label">Longitude *</label>
                                <input type="number" class="form-control" id="rec_longitude" step="0.000001" min="-180" max="180" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Panel Configuration</h6>
                            <div class="mb-3">
                                <label for="rec_surface_area" class="form-label">Surface Area (m²) *</label>
                                <input type="number" class="form-control" id="rec_surface_area" step="0.1" min="0.1" required>
                            </div>
                            <div class="mb-3">
                                <label for="rec_panel_efficiency" class="form-label">Panel Efficiency (0-1)</label>
                                <input type="number" class="form-control" id="rec_panel_efficiency" step="0.01" min="0.01" max="1" value="0.20">
                            </div>
                            <div class="mb-3">
                                <label for="rec_current_tilt" class="form-label">Current Tilt Angle (optional)</label>
                                <input type="number" class="form-control" id="rec_current_tilt" step="1" min="0" max="90">
                            </div>
                            <div class="mb-3">
                                <label for="rec_current_azimuth" class="form-label">Current Azimuth Angle (optional)</label>
                                <input type="number" class="form-control" id="rec_current_azimuth" step="1" min="0" max="360">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="submitRecommendation">
                    <i class="fas fa-crosshairs me-2"></i>
                    Get Recommendation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // === Recommendation Modal ===
    const recLocationInput = document.getElementById("rec_location_name");
    const recLatInput = document.getElementById("rec_latitude");
    const recLonInput = document.getElementById("rec_longitude");

    // Debounce function (avoid API spam)
    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Forward: Location → Coordinates
    async function fetchCoordinates(query) {
        if (!query) return;
        try {
            const res = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`
            );
            const data = await res.json();
            if (data.length > 0) {
                recLatInput.value = parseFloat(data[0].lat).toFixed(6);
                recLonInput.value = parseFloat(data[0].lon).toFixed(6);
            }
        } catch (err) {
            console.error("Error fetching coordinates:", err);
        }
    }

    // Reverse: Coordinates → Location
    async function fetchLocationName(lat, lon) {
        if (!lat || !lon) return;
        try {
            const res = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
            );
            const data = await res.json();
            if (data && data.display_name) {
                recLocationInput.value = data.display_name;
            }
        } catch (err) {
            console.error("Error fetching location:", err);
        }
    }

    // Event listeners
    recLocationInput.addEventListener("input", debounce(() => {
        fetchCoordinates(recLocationInput.value.trim());
    }, 600));

    recLatInput.addEventListener("input", debounce(() => {
        fetchLocationName(recLatInput.value, recLonInput.value);
    }, 600));

    recLonInput.addEventListener("input", debounce(() => {
        fetchLocationName(recLatInput.value, recLonInput.value);
    }, 600));
</script>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">Processing your request...</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function showToast(message, type='danger') {
        const toastContainer = document.getElementById('toast-container');
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-bg-${type} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        toastContainer.appendChild(toastEl);
        const bsToast = new bootstrap.Toast(toastEl, { delay: 5000 });
        bsToast.show();
    }
    // Prediction form submission
    document.getElementById('submitPrediction').addEventListener('click', function() {
        const form = document.getElementById('predictionForm');
        const formData = new FormData(form);
        
        const data = {
            latitude: parseFloat(formData.get('latitude') || document.getElementById('latitude').value),
            longitude: parseFloat(formData.get('longitude') || document.getElementById('longitude').value),
            location_name: formData.get('location_name') || document.getElementById('location_name').value,
            surface_area: parseFloat(formData.get('surface_area') || document.getElementById('surface_area').value),
            tilt_angle: parseFloat(formData.get('tilt_angle') || document.getElementById('tilt_angle').value),
            azimuth_angle: parseFloat(formData.get('azimuth_angle') || document.getElementById('azimuth_angle').value),
            panel_efficiency: parseFloat(formData.get('panel_efficiency') || document.getElementById('panel_efficiency').value),
            timeframe: formData.get('timeframe') || document.getElementById('timeframe').value
        };
        
        // Validate required fields
        if (!data.latitude || !data.longitude || !data.surface_area || !data.tilt_angle || data.azimuth_angle === null) {
            showToast('Please fill in all required fields');
            return;
        }
        
        // Show loading
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        loadingModal.show();
        
        // Hide prediction modal
        bootstrap.Modal.getInstance(document.getElementById('predictionModal')).hide();
        
        // Submit request
        fetch('/ajax/predict/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            loadingModal.hide();
            console.log('Server Response:', data);
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                showToast(data.error || 'Failed to generate prediction');
            }
        })
        .catch(error => {
            loadingModal.hide();
            showToast(error.message);
        });
    });
    
    // Recommendation form submission
    document.getElementById('submitRecommendation').addEventListener('click', function() {
        const form = document.getElementById('recommendationForm');
        const formData = new FormData(form);
        
        const data = {
            latitude: parseFloat(document.getElementById('rec_latitude').value),
            longitude: parseFloat(document.getElementById('rec_longitude').value),
            location_name: document.getElementById('rec_location_name').value,
            surface_area: parseFloat(document.getElementById('rec_surface_area').value),
            panel_efficiency: parseFloat(document.getElementById('rec_panel_efficiency').value)
        };
        
        // Add optional current configuration
        const currentTilt = document.getElementById('rec_current_tilt').value;
        const currentAzimuth = document.getElementById('rec_current_azimuth').value;
        
        if (currentTilt) data.current_tilt = parseFloat(currentTilt);
        if (currentAzimuth) data.current_azimuth = parseFloat(currentAzimuth);
        
        // Validate required fields
        if (!data.latitude || !data.longitude || !data.surface_area) {
            showToast('Please fill in all required fields');
            return;
        }
        
        // Show loading
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        loadingModal.show();
        
        // Hide recommendation modal
        bootstrap.Modal.getInstance(document.getElementById('recommendationModal')).hide();
        
        // Submit request
        fetch('/ajax/recommend/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            loadingModal.hide();
            
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                showToast(data.error || 'Failed to generate recommendation');
            }
        })
        .catch(error => {
            loadingModal.hide();
            showToast(error.message);
        });
    });
});

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
<script>
    // Debounce function to avoid too many API calls
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }
    
    // Get location name from lat/lon
    async function getLocationName(lat, lon) {
        if (!lat || !lon) return "";
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
        const response = await fetch(url);
        const data = await response.json();
        return data.display_name || "";
    }
    
    // Get lat/lon from location name
    async function getCoordinates(location) {
        if (!location) return null;
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${location}&limit=1`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.length > 0) {
            return { lat: data[0].lat, lon: data[0].lon };
        }
        return null;
    }
    
    // Auto update when typing location name
    document.getElementById("location_name").addEventListener("input", debounce(async () => {
        const location = document.getElementById("location_name").value;
        if (location.length > 2) { // wait till at least 3 characters
            const coords = await getCoordinates(location);
            if (coords) {
                document.getElementById("latitude").value = coords.lat;
                document.getElementById("longitude").value = coords.lon;
            }
        }
    }, 500));
    
    // Auto update when typing latitude or longitude
    async function updateLocationFromLatLon() {
        const lat = document.getElementById("latitude").value;
        const lon = document.getElementById("longitude").value;
        if (lat && lon) {
            const locationName = await getLocationName(lat, lon);
            document.getElementById("location_name").value = locationName;
        }
    }

    document.getElementById("latitude").addEventListener("input", debounce(updateLocationFromLatLon, 600));
    document.getElementById("longitude").addEventListener("input", debounce(updateLocationFromLatLon, 600));
</script>
{% endblock %}